<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SPY CONTROL v10.0 Hybrid</title>
    <style>
        :root {
            --neon: #00ffcc;
            --neon-secondary: #00aaff;
            --danger: #ff3366;
            --bg-dark: #050507;
            --card-bg: rgba(20, 20, 25, 0.95);
            --text-color: #e0e0e0;
        }
        body { 
            background-color: var(--bg-dark); color: var(--text-color); 
            font-family: 'Segoe UI', Roboto, sans-serif; 
            margin: 0; height: 100vh; display: flex; justify-content: center; align-items: center;
            background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
            overflow: hidden;
        }

        .container { 
            position: relative; z-index: 1; width: 95%; max-width: 500px; 
            background: var(--card-bg); padding: 20px; border-radius: 20px; 
            border: 1px solid rgba(0, 255, 204, 0.15);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            box-shadow: 0 0 30px rgba(0,0,0,0.6);
            max-height: 98vh; overflow-y: auto;
            display: flex; flex-direction: column;
        }

        #progress-overlay {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000; border-radius: 20px;
            flex-direction: column; justify-content: center; align-items: center;
        }
        .progress-box { width: 80%; text-align: center; }
        .progress-bar-bg {
            width: 100%; height: 8px; background: #333; border-radius: 5px;
            overflow: hidden; margin-top: 15px;
        }
        .progress-fill {
            height: 100%; width: 0%; background: linear-gradient(90deg, var(--neon), var(--neon-secondary));
            box-shadow: 0 0 15px var(--neon); transition: width 0.1s ease;
        }

        h1 { font-size: 22px; text-transform: uppercase; text-align: center; color: var(--neon); letter-spacing: 3px; margin: 5px 0 15px 0; }

        .lang-bar { display: flex; justify-content: center; gap: 8px; margin-bottom: 15px; }
        .lang-btn { background: rgba(255,255,255,0.05); border: 1px solid #444; color: #888; padding: 4px 10px; border-radius: 6px; cursor: pointer; font-size: 10px; }
        .lang-btn.active { border-color: var(--neon); color: black; background: var(--neon); }

        .input-box { background: rgba(0,0,0,0.3); padding: 12px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #222; }
        .box-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .lbl-title { font-size: 10px; font-weight: bold; color: var(--neon-secondary); letter-spacing: 1px; }
        
        /* –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—è */
        .toggle-mode { font-size: 9px; padding: 2px 6px; background: #222; border: 1px solid #444; color: #aaa; border-radius: 4px; cursor: pointer; text-transform: uppercase; }
        .toggle-mode:hover { border-color: var(--neon); color: var(--neon); }

        input[type="text"] { 
            width: 100%; padding: 10px; background: #0b0b0b; border: 1px solid #333; 
            color: white; border-radius: 8px; box-sizing: border-box; font-size: 12px; outline: none;
        }
        input[type="file"] { display: none; }
        .file-label { 
            display: block; width: 100%; padding: 10px; text-align: center; background: #111; 
            border: 1px dashed #444; border-radius: 8px; color: #666; cursor: pointer; font-size: 11px; box-sizing: border-box;
        }
        .file-label.file-selected { border-color: var(--neon); color: var(--neon); background: rgba(0,255,204,0.05); border-style: solid; }

        .input-wrapper { display: flex; gap: 8px; align-items: center; position: relative; }
        .sound-menu-btn { 
            background: #111; border: 1px solid #333; color: var(--neon-secondary); 
            border-radius: 8px; width: 40px; height: 36px; display: flex; justify-content: center; align-items: center; cursor: pointer;
        }

        .sound-dropdown { 
            display: none; position: absolute; top: 40px; right: 0; width: 100%; 
            background: #121212; border: 1px solid var(--neon-secondary); border-radius: 10px; 
            z-index: 1000; max-height: 200px; overflow-y: auto;
        }
        .sound-dropdown.show { display: block; }
        .sound-item { padding: 8px 12px; border-bottom: 1px solid #222; font-size: 12px; cursor: pointer; display: flex; justify-content: space-between; }
        .sound-item:hover { background: var(--neon-secondary); color: black; }

        button.main-btn { 
            width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: bold; 
            cursor: pointer; text-transform: uppercase; margin-top: 5px; font-size: 12px; transition: 0.2s;
        }
        .btn-create { background: var(--neon); color: #050507; }
        .btn-update { background: transparent; color: var(--neon); border: 1px solid var(--neon); }
        .btn-scare { background: #222; color: #555; height: 50px; cursor: not-allowed; }
        .btn-scare.ready { background: var(--danger); color: white; cursor: pointer; }

        .hidden { display: none !important; }
        .link-box { background: #000; padding: 10px; border-radius: 8px; border: 1px dashed #444; margin: 10px 0; word-break: break-all; font-size: 11px; text-align: center; color: var(--neon-secondary); }
    </style>
</head>
<body>
    <div class="container">
        <div id="progress-overlay">
            <div class="progress-box">
                <div style="color:var(--neon); font-size:12px;" id="p-status">UPLOADING...</div>
                <div class="progress-bar-bg"><div class="progress-fill" id="p-fill"></div></div>
                <div id="p-text" style="font-size:10px; margin-top:5px;">0%</div>
            </div>
        </div>

        <div class="lang-bar">
            <button class="lang-btn active" onclick="setLang('uk')">UA</button>
            <button class="lang-btn" onclick="setLang('ru')">RU</button>
            <button class="lang-btn" onclick="setLang('en')">EN</button>
        </div>

        <h1 id="txt-title">üëÅÔ∏è SPY CONTROL</h1>

        <div id="setup-step">
            <div class="input-box">
                <div class="box-header">
                    <span class="lbl-title" id="lbl-img">–ó–û–ë–†–ê–ñ–ï–ù–ù–Ø</span>
                    <div class="toggle-mode" onclick="toggleField('img')">Switch Mode</div>
                </div>
                <div id="img-url-wrap">
                    <input type="text" id="imgUrl" placeholder="https://site.com/image.jpg">
                </div>
                <div id="img-file-wrap" class="hidden">
                    <label for="imgFile" id="lbl-imgFile" class="file-label">–í–∏–±—Ä–∞—Ç–∏ —Ñ–æ—Ç–æ</label>
                    <input type="file" id="imgFile" accept="image/*" onchange="updLbl(this, 'lbl-imgFile')">
                </div>
            </div>

            <div class="input-box">
                <div class="box-header">
                    <span class="lbl-title" id="lbl-snd">–ó–í–£–ö</span>
                    <div class="toggle-mode" onclick="toggleField('snd')">Switch Mode</div>
                </div>
                <div id="snd-url-wrap">
                    <div class="input-wrapper">
                        <input type="text" id="sndUrl" value="https://soundbible.com/grab.php?id=1549&type=mp3">
                        <div class="sound-menu-btn" onclick="toggleMenu('create')">‚ò∞</div>
                        <div id="menu-create" class="sound-dropdown"></div>
                    </div>
                </div>
                <div id="snd-file-wrap" class="hidden">
                    <label for="sndFile" id="lbl-sndFile" class="file-label">–í–∏–±—Ä–∞—Ç–∏ MP3</label>
                    <input type="file" id="sndFile" accept="audio/*" onchange="updLbl(this, 'lbl-sndFile')">
                </div>
            </div>

            <button class="main-btn btn-create" onclick="handleAction('create')" id="btn-create">–°–¢–í–û–†–ò–¢–ò –ü–ê–°–¢–ö–£</button>
        </div>

        <div id="control-panel" style="display:none;">
            <div class="link-box" id="victim-link-box">Generating...</div>
            
            <div class="input-box" style="border-color: var(--neon-secondary);">
                <span class="lbl-title" id="lbl-upd" style="color:var(--neon-secondary)">LIVE UPDATE</span>
                <div style="margin-top:8px; display:grid; gap:5px;">
                    <input type="text" id="updImgUrl" placeholder="New Image URL">
                    <label for="updImgFile" id="lbl-updImg" class="file-label" style="padding:5px;">+ OR UPLOAD PHOTO</label>
                    <input type="file" id="updImgFile" accept="image/*" onchange="updLbl(this, 'lbl-updImg')">
                    
                    <input type="text" id="updSndUrl" placeholder="New Sound URL">
                    <label for="updSndFile" id="lbl-updSnd" class="file-label" style="padding:5px;">+ OR UPLOAD MP3</label>
                    <input type="file" id="updSndFile" accept="audio/*" onchange="updLbl(this, 'lbl-updSnd')">
                </div>
                <button class="main-btn btn-update" onclick="handleAction('update')" id="btn-update">–û–ù–û–í–ò–¢–ò</button>
            </div>

            <div id="users-list" style="text-align:center; margin-bottom:10px; font-size:11px;"></div>
            <button id="scare-btn" class="main-btn btn-scare" onclick="triggerScare()" disabled>SCREAMER üíÄ</button>
            <button onclick="location.reload()" style="background:transparent; color:#555; border:none; margin-top:10px; width:100%; font-size:10px; cursor:pointer;">‚¨Ö BACK TO MENU</button>
        </div>

        <div id="history-panel">
            <div id="history-list"></div>
        </div>
    </div>

    <audio id="preview-audio"></audio>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let curSess = null;
        let fieldModes = { img: 'url', snd: 'url' };

        // --- UI ---
        function toggleField(type) {
            fieldModes[type] = fieldModes[type] === 'url' ? 'file' : 'url';
            document.getElementById(`${type}-url-wrap`).classList.toggle('hidden', fieldModes[type] === 'file');
            document.getElementById(`${type}-file-wrap`).classList.toggle('hidden', fieldModes[type] === 'url');
        }

        function updLbl(inp, id) {
            const l = document.getElementById(id);
            if(inp.files.length) { l.innerText = "‚úì " + inp.files[0].name.slice(0,20); l.classList.add('file-selected'); }
            else { l.innerText = "..."; l.classList.remove('file-selected'); }
        }

        // --- CORE LOGIC (Hybrid & Fast) ---
        async function handleAction(act) {
            const isUpd = act === 'update';
            const fd = new FormData();
            let hasFiles = false;
            
            // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            const imgF = document.getElementById(isUpd ? 'updImgFile' : 'imgFile').files[0];
            const sndF = document.getElementById(isUpd ? 'updSndFile' : 'sndFile').files[0];
            const imgU = document.getElementById(isUpd ? 'updImgUrl' : 'imgUrl').value;
            const sndU = document.getElementById(isUpd ? 'updSndUrl' : 'sndUrl').value;

            // –ï—Å–ª–∏ —ç—Ç–æ —Å–æ–∑–¥–∞–Ω–∏–µ, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º—ã –ø–æ–ª–µ–π
            let finalImg = imgU, finalSnd = sndU;

            if (imgF) { fd.append('images', imgF); hasFiles = true; }
            if (sndF) { fd.append('sounds', sndF); hasFiles = true; }

            try {
                let resData;
                if (isUpd) {
                    // LIVE UPDATE
                    if (imgU || sndU) {
                        await fetch(`/update-session/${curSess}`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ image: imgU, sound: sndU })
                        });
                    }
                    if (imgF) await upload(`/session/${curSess}/upload-images`, fd, 'image');
                    if (sndF) await upload(`/session/${curSess}/upload-sounds`, fd, 'sound');
                    alert("Updated!");
                } else {
                    // CREATE TRAP
                    if (hasFiles) {
                        // –ï—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—å –æ–¥–∏–Ω —Ñ–∞–π–ª, –∏—Å–ø–æ–ª—å–∑—É–µ–º multipart (–±—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞)
                        fd.append('image', imgU); // –°—Å—ã–ª–∫–∞ –µ—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç
                        fd.append('sound', sndU);
                        resData = await upload('/create-upload', fd, 'All data');
                    } else {
                        // –ß–∏—Å—Ç—ã–π JSON –µ—Å–ª–∏ —Ç–æ–ª—å–∫–æ —Å—Å—ã–ª–∫–∏
                        const r = await fetch('/create', {
                            method:'POST',
                            headers:{'Content-Type':'application/json'},
                            body:JSON.stringify({image:imgU, sound:sndU})
                        });
                        resData = await r.json();
                    }
                    activate(resData.id, resData.shortUrl);
                }
            } catch (e) { alert("Error: " + e); }
        }

        function upload(url, fd, type) {
            return new Promise((res, rej) => {
                const xhr = new XMLHttpRequest();
                const fill = document.getElementById('p-fill');
                const txt = document.getElementById('p-text');
                const overlay = document.getElementById('progress-overlay');

                overlay.style.display = 'flex';
                xhr.open('POST', url);
                xhr.upload.onprogress = e => {
                    if(e.lengthComputable) {
                        const p = Math.round((e.loaded/e.total)*100);
                        fill.style.width = p + '%';
                        txt.innerText = `${p}%`;
                    }
                };
                xhr.onload = () => {
                    overlay.style.display = 'none';
                    if(xhr.status >= 200 && xhr.status < 300) res(JSON.parse(xhr.response));
                    else rej("Server error");
                };
                xhr.send(fd);
            });
        }

        function activate(id, short) {
            curSess = id;
            document.getElementById('setup-step').style.display='none';
            document.getElementById('control-panel').style.display='block';
            const link = short ? `${window.location.origin}/${short}` : `${window.location.origin}/victim.html?id=${id}`;
            document.getElementById('victim-link-box').innerText = link;
            socket.emit('join-room-admin', id);
        }

        function triggerScare() { socket.emit('trigger-scare', curSess); }

        socket.on('update-victim-list', u => {
            const btn = document.getElementById('scare-btn');
            btn.disabled = u.length === 0;
            btn.classList.toggle('ready', u.length > 0);
            document.getElementById('users-list').innerHTML = u.length ? 
                u.map(v => `<div style="color:var(--neon)">Online: ${v.device}</div>`).join('') : "Waiting...";
        });

        // --- HELPERS (Sounds & Langs) ---
        const sounds = [{n:"Safonov", u:"https://www.myinstants.com/media/sounds/safonov-oplatit.mp3"},{n:"Knock", u:"https://www.myinstants.com/media/sounds/knocking-on-door.mp3"},{n:"Screamer", u:"https://www.myinstants.com/media/sounds/scream_horror1.mp3"}];
        function renderMenus() {
            document.getElementById('menu-create').innerHTML = sounds.map(s => `<div class="sound-item" onclick="document.getElementById('sndUrl').value='${s.u}'">${s.n} <span>‚ñ∂</span></div>`).join('');
        }
        function toggleMenu(t) { document.getElementById(`menu-${t}`).classList.toggle('show'); }
        function setLang(l) { /* –£–ø—Ä–æ—Å—Ç–∏–º –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞ */ }

        window.onload = () => { renderMenus(); };
    </script>
</body>
</html>
