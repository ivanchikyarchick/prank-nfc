<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPY CONTROL v2.1</title>
    <style>
        :root {
            --neon: #00ff99;
            --danger: #ff0055;
            --bg: #0a0a0c;
            --card: #16161a;
        }
        body { 
            background-color: var(--bg); color: white; 
            font-family: 'Segoe UI', Roboto, sans-serif; 
            display: flex; justify-content: center; padding: 20px; margin: 0;
            background-image: radial-gradient(circle at 50% 50%, #1a1a2e 0%, #0a0a0c 100%);
        }
        .container { 
            width: 100%; max-width: 450px; background: var(--card); 
            padding: 25px; border-radius: 20px; border: 1px solid #333;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .lang-bar { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; }
        .lang-btn { 
            background: #222; border: 1px solid #444; color: #aaa; 
            padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; transition: 0.3s;
        }
        .lang-btn.active { border-color: var(--neon); color: var(--neon); background: rgba(0,255,153,0.1); }
        
        h1 { font-size: 22px; letter-spacing: 2px; text-transform: uppercase; color: var(--neon); margin-top: 0; text-align: center; }
        
        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 12px; color: #777; margin-bottom: 5px; }
        input { 
            width: 100%; padding: 12px; background: #0f0f12; border: 1px solid #333; 
            color: white; border-radius: 10px; box-sizing: border-box; outline: none; margin-bottom: 10px;
        }
        input:focus { border-color: var(--neon); }
        
        button { 
            width: 100%; padding: 15px; border: none; border-radius: 10px; 
            cursor: pointer; font-size: 15px; font-weight: bold; transition: 0.3s;
        }
        .btn-create { background: var(--neon); color: black; }
        .btn-update { background: #333; color: white; font-size: 13px; }
        .btn-scare { 
            background: var(--danger); color: white; height: 80px; font-size: 22px; 
            display: none; margin-top: 20px; animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,0,85,0.7); } 70% { box-shadow: 0 0 0 15px rgba(255,0,85,0); } 100% { box-shadow: 0 0 0 0 rgba(255,0,85,0); } }

        .history-item { 
            background: #1c1c21; padding: 12px; margin-bottom: 10px; border-radius: 10px; 
            display: flex; justify-content: space-between; align-items: center; border: 1px solid #333;
        }
        .history-info { cursor: pointer; flex-grow: 1; }
        .btn-delete { 
            background: transparent; color: #ff4444; width: auto; padding: 5px 10px; 
            font-size: 18px; opacity: 0.6; 
        }
        .btn-delete:hover { opacity: 1; }

        .link-box { 
            background: #000; padding: 10px; border-radius: 8px; font-family: monospace; 
            font-size: 11px; margin: 15px 0; border: 1px dashed #444; word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="lang-bar">
            <button class="lang-btn active" onclick="setLang('uk')">UA</button>
            <button class="lang-btn" onclick="setLang('ru')">RU</button>
            <button class="lang-btn" onclick="setLang('en')">EN</button>
            <button class="lang-btn" onclick="setLang('ja')">JP</button>
        </div>

        <h1 id="t-title">üëÅÔ∏è SPY CONTROL</h1>
        
        <div id="setup-step">
            <input type="text" id="imgUrl" placeholder="URL –ö–∞—Ä—Ç–∏–Ω–∫–∏">
            <input type="text" id="sndUrl" placeholder="URL –ó–≤—É–∫—É (.mp3)" value="https://www.myinstants.com/media/sounds/scream.mp3">
            <button class="btn-create" onclick="createLink()" id="t-btn-create">–°–¢–í–û–†–ò–¢–ò –ü–ê–°–¢–ö–£</button>
        </div>

        <div id="control-panel" style="display: none;">
            <div class="link-box">
                <a id="victim-link" href="#" target="_blank" style="color: #4db8ff; text-decoration: none;">...</a>
            </div>
            
            <div style="background: #1c1c21; padding: 15px; border-radius: 12px;">
                <label id="t-update-label" style="color: var(--neon);">–û–ù–û–í–ò–¢–ò –ú–ï–î–Ü–ê</label>
                <input type="text" id="newImgUrl" placeholder="–ù–æ–≤–∏–π URL –∫–∞—Ä—Ç–∏–Ω–∫–∏">
                <input type="text" id="newSndUrl" placeholder="–ù–æ–≤–∏–π URL –∑–≤—É–∫—É">
                <button onclick="updateMedia()" class="btn-update" id="t-btn-update">–û–ù–û–í–ò–¢–ò –î–õ–Ø –í–°–Ü–•</button>
            </div>

            <div id="live-users-panel">
                <div id="users-list"></div>
            </div>

            <button id="scare-btn" class="btn-scare" onclick="trigger()">–ù–ê–õ–Ø–ö–ê–¢–ò üíÄ</button>
            <button onclick="location.reload()" style="background: transparent; color: #555; margin-top: 15px; font-size: 13px;" id="t-btn-back">‚¨Ö –ú–µ–Ω—é</button>
        </div>

        <div id="history-panel">
            <h3 id="t-history" style="color: #555; font-size: 14px; margin-top: 30px;">–Ü–°–¢–û–†–Ü–Ø –°–ï–°–Ü–ô</h3>
            <div id="history-list"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentSessionId = null;

        const i18n = {
            uk: { title: "üëÅÔ∏è SPY CONTROL", create: "–°–¢–í–û–†–ò–¢–ò –ü–ê–°–¢–ö–£", update: "–û–ù–û–í–ò–¢–ò –ú–ï–î–Ü–ê", btnUpdate: "–û–ù–û–í–ò–¢–ò –î–õ–Ø –í–°–Ü–•", scare: "–ù–ê–õ–Ø–ö–ê–¢–ò üíÄ", back: "‚¨Ö –ú–µ–Ω—é", history: "–Ü–°–¢–û–†–Ü–Ø –°–ï–°–Ü–ô", delConfirm: "–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—é —Å–µ—Å—ñ—é?" },
            ru: { title: "üëÅÔ∏è SPY CONTROL", create: "–°–û–ó–î–ê–¢–¨ –õ–û–í–£–®–ö–£", update: "–û–ë–ù–û–í–ò–¢–¨ –ú–ï–î–ò–ê", btnUpdate: "–û–ë–ù–û–í–ò–¢–¨ –î–õ–Ø –í–°–ï–•", scare: "–ò–°–ü–£–ì–ê–¢–¨ üíÄ", back: "‚¨Ö –ú–µ–Ω—é", history: "–ò–°–¢–û–†–ò–Ø –°–ï–°–°–ò–ô", delConfirm: "–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å–µ—Å—Å–∏—é?" },
            en: { title: "üëÅÔ∏è SPY CONTROL", create: "CREATE TRAP", update: "UPDATE MEDIA", btnUpdate: "UPDATE FOR ALL", scare: "SCARE 'EM üíÄ", back: "‚¨Ö Menu", history: "SESSION HISTORY", delConfirm: "Delete this session?" },
            ja: { title: "üëÅÔ∏è „Çπ„Éë„Ç§„Ç≥„É≥„Éà„É≠„Éº„É´", create: "„Éà„É©„ÉÉ„Éó„Çí‰ΩúÊàê", update: "„É°„Éá„Ç£„Ç¢„ÇíÊõ¥Êñ∞", btnUpdate: "ÂÖ®Âì°„ÇíÊõ¥Êñ∞", scare: "ÊÄñ„Åå„Çâ„Åõ„Çã üíÄ", back: "‚¨Ö „É°„Éã„É•„Éº", history: "„Çª„ÉÉ„Ç∑„Éß„É≥Â±•Ê≠¥", delConfirm: "„Åì„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü" }
        };

        function setLang(lang) {
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('t-title').innerText = i18n[lang].title;
            document.getElementById('t-btn-create').innerText = i18n[lang].create;
            document.getElementById('t-update-label').innerText = i18n[lang].update;
            document.getElementById('t-btn-update').innerText = i18n[lang].btnUpdate;
            document.getElementById('t-btn-back').innerText = i18n[lang].back;
            document.getElementById('t-history').innerText = i18n[lang].history;
            window.currentLang = lang;
        }
        window.currentLang = 'uk';

        window.onload = loadHistory;

        async function createLink() {
            const image = document.getElementById('imgUrl').value.trim();
            const sound = document.getElementById('sndUrl').value.trim();
            const res = await fetch('/create', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ image, sound })
            });
            const data = await res.json();
            saveToHistory(data.id);
            activateRoom(data.id);
        }

        async function updateMedia() {
            if (!currentSessionId) return;
            const image = document.getElementById('newImgUrl').value.trim();
            const sound = document.getElementById('newSndUrl').value.trim();
            
            const body = {};
            if (image) body.image = image;
            if (sound) body.sound = sound;

            await fetch(`/update-session/${currentSessionId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            alert('Updated!');
        }

        function activateRoom(id) {
            currentSessionId = id;
            document.getElementById('setup-step').style.display = 'none';
            document.getElementById('history-panel').style.display = 'none';
            document.getElementById('control-panel').style.display = 'block';
            const link = `${window.location.origin}/victim.html?id=${id}`;
            document.getElementById('victim-link').href = link;
            document.getElementById('victim-link').innerText = link;
            socket.emit('join-room-admin', id);
        }

        async function deleteSession(id, event) {
            event.stopPropagation();
            if (!confirm(i18n[window.currentLang].delConfirm)) return;

            // –ó–∞–ø–∏—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è (—è–∫—â–æ —Å–µ—Ä–≤–µ—Ä –ø—ñ–¥—Ç—Ä–∏–º—É—î)
            await fetch(`/delete-session/${id}`, { method: 'DELETE' }).catch(() => {});

            let list = JSON.parse(localStorage.getItem('prank_rooms') || '[]');
            list = list.filter(item => item.id !== id);
            localStorage.setItem('prank_rooms', JSON.stringify(list));
            loadHistory();
        }

        function trigger() {
            if(currentSessionId) socket.emit('trigger-scare', currentSessionId);
        }

        socket.on('update-victim-list', (users) => {
            const listDiv = document.getElementById('users-list');
            const scareBtn = document.getElementById('scare-btn');
            if (users.length > 0) {
                scareBtn.style.display = 'block';
                listDiv.innerHTML = users.map(u => `<div style="font-size:10px; color:var(--neon); margin-top:5px;">‚óè Online: ${u.device}</div>`).join('');
            } else {
                scareBtn.style.display = 'none';
                listDiv.innerHTML = '';
            }
        });

        function saveToHistory(id) {
            const list = JSON.parse(localStorage.getItem('prank_rooms') || '[]');
            if (!list.find(i => i.id === id)) {
                list.unshift({ id, date: new Date().toLocaleString() });
                localStorage.setItem('prank_rooms', JSON.stringify(list.slice(0, 20)));
            }
        }

        async function loadHistory() {
            const list = JSON.parse(localStorage.getItem('prank_rooms') || '[]');
            const container = document.getElementById('history-list');
            container.innerHTML = '';
            
            if (list.length === 0) return;

            const res = await fetch('/check-status', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ ids: list.map(i => i.id) })
            }).catch(() => ({ json: () => [] }));
            
            const statuses = await res.json();

            list.forEach(item => {
                const status = statuses.find(s => s.id === item.id) || { count: 0 };
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
                    <div class="history-info" onclick="activateRoom('${item.id}')">
                        <span style="font-size:12px;">ID: ...${item.id.slice(-6)}</span>
                        <span style="color:${status.count > 0 ? 'var(--neon)' : '#555'}; font-size:10px; margin-left:10px;">‚óè ${status.count}</span>
                    </div>
                    <button class="btn-delete" onclick="deleteSession('${item.id}', event)">üóëÔ∏è</button>
                `;
                container.appendChild(div);
            });
        }
    </script>
</body>
</html>
