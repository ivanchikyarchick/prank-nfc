<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Base</title>
    <style>
        body { background-color: #0d0d0d; color: #00ff99; font-family: 'Courier New', monospace; text-align: center; padding: 10px; }
        .container { max-width: 500px; margin: 0 auto; background: #1a1a1a; padding: 15px; border-radius: 10px; border: 1px solid #333; }
        input { width: 90%; padding: 12px; margin: 5px 0; background: #222; border: 1px solid #444; color: white; border-radius: 5px; }
        button { width: 100%; padding: 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 10px; }
        
        .btn-create { background: #00ff99; color: black; }
        .btn-scare { background: #ff0055; color: white; height: 100px; font-size: 28px; display: none; margin-top: 20px; box-shadow: 0 0 20px rgba(255, 0, 85, 0.4); }
        .btn-scare:active { transform: scale(0.98); }
        
        /* –°—Ç–∏–ª—ñ –¥–ª—è —ñ—Å—Ç–æ—Ä—ñ—ó */
        #history-panel { margin-top: 30px; text-align: left; }
        .history-item { background: #222; padding: 10px; margin-bottom: 8px; border-radius: 5px; border-left: 3px solid #555; cursor: pointer; transition: 0.2s; font-size: 12px; display: flex; justify-content: space-between; align-items: center;}
        .history-item:hover { background: #333; }
        .active-room { border-left: 3px solid #00ff99; box-shadow: 0 0 10px rgba(0, 255, 153, 0.1); }
        .status-dot { height: 10px; width: 10px; background-color: #555; border-radius: 50%; display: inline-block; margin-right: 5px;}
        .online { background-color: #00ff99; box-shadow: 0 0 5px #00ff99; }

        /* –õ–æ–≥ –∂–µ—Ä—Ç–≤–∏ */
        #victim-log { display: none; margin-top: 15px; padding: 10px; background: #2a2a00; border: 1px solid #ffff00; color: #ffff00; font-size: 12px; text-align: left; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üëÅÔ∏è CONTROL CENTER</h1>
        
        <div id="setup-step">
            <input type="text" id="imgUrl" placeholder="–ö–∞—Ä—Ç–∏–Ω–∫–∞ (URL)">
            <input type="text" id="sndUrl" placeholder="–ó–≤—É–∫ (URL .mp3)" value="https://www.myinstants.com/media/sounds/scream.mp3">
            <button class="btn-create" onclick="createLink()">–°–¢–í–û–†–ò–¢–ò –ü–ê–°–¢–ö–£</button>
        </div>

        <div id="control-panel" style="display: none;">
            <div style="background: #333; padding: 10px; border-radius: 5px; word-break: break-all;">
                <span style="color: #aaa; font-size: 12px;">–ü–æ—Å–∏–ª–∞–Ω–Ω—è –¥–ª—è –∂–µ—Ä—Ç–≤–∏:</span><br>
                <a id="victim-link" href="#" target="_blank" style="color: #4db8ff; font-size: 14px;">...</a>
            </div>
            
            <div id="victim-log"></div>
            <button id="scare-btn" class="btn-scare" onclick="trigger()">–ù–ê–õ–Ø–ö–ê–¢–ò üíÄ</button>
            <button onclick="location.reload()" style="background: #333; color: #888; margin-top: 20px; font-size: 12px; padding: 10px;">‚¨Ö –ù–∞–∑–∞–¥ –¥–æ –º–µ–Ω—é</button>
        </div>

        <div id="history-panel">
            <h3 style="color: #666; font-size: 14px; border-bottom: 1px solid #333; padding-bottom: 5px;">–Ü–°–¢–û–†–Ü–Ø –ö–Ü–ú–ù–ê–¢</h3>
            <div id="history-list"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentSessionId = null;

        // 1. –ü—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ - –º–∞–ª—é—î–º–æ —ñ—Å—Ç–æ—Ä—ñ—é
        window.onload = loadHistory;

        async function createLink() {
            const image = document.getElementById('imgUrl').value;
            const sound = document.getElementById('sndUrl').value;
            
            const res = await fetch('/create', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ image, sound })
            });
            const data = await res.json();
            
            saveToHistory(data.id, data.createdAt); // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤ —Ç–µ–ª–µ—Ñ–æ–Ω
            activateRoom(data.id); // –í–º–∏–∫–∞—î–º–æ –ø—É–ª—å—Ç
            loadHistory(); // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫
        }

        // –í—Ö—ñ–¥ —É –≤–∂–µ —Å—Ç–≤–æ—Ä–µ–Ω—É –∫—ñ–º–Ω–∞—Ç—É
        function activateRoom(id) {
            currentSessionId = id;
            
            // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è UI
            document.getElementById('setup-step').style.display = 'none';
            document.getElementById('history-panel').style.display = 'none'; // –•–æ–≤–∞—î–º–æ —ñ—Å—Ç–æ—Ä—ñ—é, —â–æ–± –Ω–µ –∑–∞–≤–∞–∂–∞–ª–∞
            document.getElementById('control-panel').style.display = 'block';
            document.getElementById('scare-btn').style.display = 'block';
            
            const link = `${window.location.origin}/victim.html?id=${id}`;
            document.getElementById('victim-link').href = link;
            document.getElementById('victim-link').innerText = link;
            document.getElementById('victim-log').style.display = 'none';

            // –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ —Å–æ–∫–µ—Ç–∏
            socket.emit('join-room', id);
        }

        // –ö–Ω–æ–ø–∫–∞ "–ù–∞–ª—è–∫–∞—Ç–∏"
        function trigger() {
            if(currentSessionId) socket.emit('trigger-scare', currentSessionId);
        }

        // --- –õ–û–ì–Ü–ö–ê –Ü–°–¢–û–†–Ü–á (LocalStorage) ---
        function getSavedIds() {
            const saved = localStorage.getItem('prank_rooms');
            return saved ? JSON.parse(saved) : [];
        }

        function saveToHistory(id, date) {
            const list = getSavedIds();
            // –î–æ–¥–∞—î–º–æ –Ω–æ–≤—É –Ω–∞ –ø–æ—á–∞—Ç–æ–∫
            list.unshift({ id, date });
            // –¢—Ä–∏–º–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ –æ—Å—Ç–∞–Ω–Ω—ñ 10
            if(list.length > 10) list.pop();
            localStorage.setItem('prank_rooms', JSON.stringify(list));
        }

        async function loadHistory() {
            const list = getSavedIds();
            if(list.length === 0) {
                document.getElementById('history-list').innerHTML = '<span style="color:#444; font-size: 12px;">–ü—É—Å—Ç–æ...</span>';
                return;
            }

            // –ó–∞–ø–∏—Ç—É—î–º–æ —É —Å–µ—Ä–≤–µ—Ä–∞, —Ö—Ç–æ –æ–Ω–ª–∞–π–Ω
            const idsOnly = list.map(item => item.id);
            const res = await fetch('/check-status', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ ids: idsOnly })
            });
            const statuses = await res.json(); // –ü—Ä–∏—Ö–æ–¥–∏—Ç—å –≤—ñ–¥—Å–æ—Ä—Ç–æ–≤–∞–Ω–∏–π –º–∞—Å–∏–≤

            const container = document.getElementById('history-list');
            container.innerHTML = '';

            statuses.forEach(room => {
                // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –¥–∞—Ç—É —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è
                const localItem = list.find(l => l.id === room.id);
                const dateStr = localItem ? localItem.date : 'Unknown';
                const isActive = room.active;

                const div = document.createElement('div');
                div.className = `history-item ${isActive ? 'active-room' : ''}`;
                div.onclick = () => activateRoom(room.id);
                div.innerHTML = `
                    <div>
                        <span class="status-dot ${isActive ? 'online' : ''}"></span>
                        <span style="color: white; font-weight: bold;">–ö—ñ–º–Ω–∞—Ç–∞...${room.id.slice(0, 4)}</span>
                        <br>
                        <span style="color: #777;">üïí ${dateStr}</span>
                    </div>
                    ${isActive ? '<span style="color: #00ff99;">–û–ù–õ–ê–ô–ù üî•</span>' : '<span style="color: #555;">–ü—É—Å—Ç–æ</span>'}
                `;
                container.appendChild(div);
            });
        }

        // --- –°–ü–û–í–Ü–©–ï–ù–ù–Ø –ü–†–û –ñ–ï–†–¢–í–£ ---
        socket.on('admin-alert', (data) => {
            const log = document.getElementById('victim-log');
            log.style.display = 'block';
            
            // –ü—Ä–æ—Å—Ç–∏–π –ø–∞—Ä—Å–∏–Ω–≥ –ø—Ä–∏—Å—Ç—Ä–æ—é
            let device = "PC";
            if(data.device.includes('Android')) device = "Android";
            if(data.device.includes('iPhone')) device = "iPhone";

            log.innerHTML = `
                <strong>${data.msg}</strong><br>
                üì± ${device}<br>
                üåê IP: ${data.ip}<br>
                üïí ${data.time}
            `;
            // –í—ñ–±—Ä–∞—Ü—ñ—è –∞–¥–º—ñ–Ω–∞, —â–æ–± –∑–Ω–∞–≤, —â–æ –ø–æ—Ä–∞ —Ç–∏—Å–Ω—É—Ç–∏
            if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
        });
    </script>
</body>
</html>
